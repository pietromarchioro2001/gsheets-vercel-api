const { google } = require('googleapis');

async function authClient() {
  const saBase64 = process.env.SERVICE_ACCOUNT_BASE64;
  const saJson = JSON.parse(Buffer.from(saBase64, 'base64').toString('utf8'));
  const jwt = new google.auth.JWT(
    saJson.client_email,
    null,
    saJson.private_key,
    ['https://www.googleapis.com/auth/spreadsheets']
  );
  await jwt.authorize();
  return jwt;
}

module.exports = async (req, res) => {
  try {
    const auth = await authClient();
    const sheets = google.sheets({ version: 'v4', auth });
    const spreadsheetId = process.env.SHEET_ID;
    const sheetName = process.env.SHEET_NAME || 'ORDINI';

    const r = await sheets.spreadsheets.values.get({
      spreadsheetId,
      range: sheetName
    });

    res.setHeader('Content-Type', 'application/json');
    res.status(200).send(JSON.stringify({ values: r.data.values || [] }));
  } catch (err) {
    console.error('get-orders error', err);
    res.status(500).send({ error: err.message || err.toString() });
  }
};
